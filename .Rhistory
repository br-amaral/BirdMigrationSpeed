s(cell_lat2, bs = "tp") +
s(sps_cell, bs = "re") +
s(cell, bs = "re")
)
summary(mod_gu)
# saveRDS(mod_gu, file = "data/res/mod_gu.rds")
# mod_gu <- readRDS(file = "data/res/mod_gu.rds")
## Figure 2 - speed and green-up (model 1) --------------------------------------------------------
### green-up date on bird speed ------------------------------------------------------------------------
svg(glue("figures/Fig2/fig2_date.svg"),
width = 4, height = 4)
plot_smooth(mod_gu, view = "AnomDGr", cond=list(mig_cell=F),
ylim = exp(c(3.7,4.6)),
rug = F, transform = "exp", log = "y",
ylab = "Bird speed (km/day, log scale)", xlab = "Anomaly on green-up date (days)",
col = "#F0E442", lwd = 3)
plot_smooth(mod_gu, view = "AnomDGr", cond=list(mig_cell=F),
ylim = exp(c(3.7,4.6)),
rug = F, transform = "exp", log = "y",
ylab = "Bird speed (km/day, log scale)", xlab = "Anomaly on green-up date (days)",
col = "#F0E442", lwd = 3)
summary(mod_gu)
str(final2)
final2 <- readRDS("~/OneDrive/BirdMigrationSpeed_copy/final.rds") %>%
#"~/Library/CloudStorage/OneDrive-ThePennsylvaniaStateUniversity/BirdMigrationSpeed_copy/data/final.rds") %>%
mutate(species = as.factor(species),
cell = as.factor(cell),
#mig_cell = abs(mig_cell - 1),
mig_cell = as.factor(mig_cell),# %>% as.numeric(),
sps_cell = as.factor(glue("{species}_{cell}"))
)
finalG <- final2 %>%
dplyr::select(cell, year, cell_lat2, vGrMag, gr_mn, mig_cell, breed_cell) %>%
distinct() %>%
mutate(cell = as.factor(cell),
mig_cell = as.factor(mig_cell))
# Model 1 - bird speed varying with green-up --------------------------------------------------------
mod_gu <-
mgcv::gam(data = final2,
log(vArrMag) ~ (AnomDGr + AnomVGr) * mig_cell +
s(year, bs = "re") +
s(cell_lat2, bs = "tp") +
s(sps_cell, bs = "re") +
s(cell, bs = "re")
)
summary(mod_gu)
## Figure 2 - speed and green-up (model 1) --------------------------------------------------------
### green-up date on bird speed ------------------------------------------------------------------------
svglite::svglite(glue("figures/Fig2/fig2_date.svg"),
width = 4, height = 4)
plot_smooth(mod_gu, view = "AnomDGr", cond=list(mig_cell=F),
ylim = exp(c(3.7,4.6)),
rug = F, transform = "exp", log = "y",
ylab = "Bird speed (km/day, log scale)", xlab = "Anomaly on green-up date (days)",
col = "#F0E442", lwd = 3)
plot_smooth(mod_gu, view = "AnomDGr", cond=list(mig_cell=T), add = T,
rug = F,lty = "dashed", transform = "exp", log = "y",
col = "#E69F00", lwd = 3)
## Figure 2 - speed and green-up (model 1) --------------------------------------------------------
### green-up date on bird speed ------------------------------------------------------------------------
svglite::svglite(glue("figures/Fig2/fig2_date.svg"),
width = 4, height = 4)
svglite::svglite(glue("figures/Fig2/fig2_date.svg")
)
## Figure 2 - speed and green-up (model 1) --------------------------------------------------------
### green-up date on bird speed ------------------------------------------------------------------------
svglite::svglite(glue("figures/Fig2/fig2_date.svg"),
width = 4, height = 4)
plot_smooth(mod_gu, view = "AnomDGr", cond=list(mig_cell=F),
ylim = exp(c(3.7,4.6)),
rug = F, transform = "exp", log = "y",
ylab = "Bird speed (km/day, log scale)", xlab = "Anomaly on green-up date (days)",
col = "#F0E442", lwd = 3)
plot_smooth(mod_gu, view = "AnomDGr", cond=list(mig_cell=T), add = T,
rug = F,lty = "dashed", transform = "exp", log = "y",
col = "#E69F00", lwd = 3)
dev.off()
### green-up speed on bird speed  ------------------------------------------------------------------------
svg(glue("figures/Fig2/fig2_speed.svg"),
width = 4, height = 4)
plot_smooth(mod_gu, view = "AnomVGr", cond=list(mig_cell=T),
lty = "dashed", rug = F, transform = "exp", log = "y",
ylab = NA, xlab = "Anomaly on green-up speed (km/day)",
col = "#E69F00", lwd = 3, ylim = exp(c(3.7, 4.6)))
plot_smooth(mod_gu, view = "AnomVGr", cond=list(mig_cell=F),
add = T, rug = F, transform = "exp", log = "y",
col = "#F0E442", lwd = 3)
dev.off()
plot_smooth(mod_gu, view = "cell_lat2", cond=list(mig_cell=F),
ylim = exp(c(2.5,4.6)),
rug = F, transform = "exp", log = "y",
ylab = "Bird speed (km/day, log scale)", xlab = "Latitude",
col = "#F0E442", lwd = 3)
plot_smooth(mod_gu, view = "cell_lat2", cond=list(mig_cell=T), add = T,
rug = F,lty = "dashed", transform = "exp", log = "y",
col = "#E69F00", lwd = 3)
legend(35, 20, legend=c("Breeding cell", "Migratory cell"),
col=c("#F0E442", "#E69F00"), lty = 1, cex=1, lwd = 2)
### range on bird speed ------------------------------------------------------------------------
newdata <- data.frame(AnomDGr = rep(0,2),
AnomVGr = rep(0,2), # mean(final$AnomVGr, na.rm = T),
mig_cell = as.factor(c(T,F)))
newdata <- newdata %>% distinct()
newdata$species <- 1
newdata$year <- 1
newdata$cell_lat2 <- 1
newdata$cell <- 1
newdata$sps_cell <- 1
yhat.incgu <- predict(mod_gu,
newdata = newdata,
se.fit = TRUE, iterms.type=2, re.form=NA,exclude = list("s(year)","s(cell_lat2)","s(sps_cell)", "s(cell)"))
mig_efftab <- as.data.frame(matrix(ncol = 3,
data = c(yhat.incgu$fit,
yhat.incgu$fit + yhat.incgu$se.fit,
yhat.incgu$fit - yhat.incgu$se.fit),
byrow = F))
colnames(mig_efftab) <- c("mean", "up","low")
mig_efftab$ran <- c("mig", "bree")
mig_efftabx <- mig_efftab %>%
mutate(mean = exp(mean),
up = exp(up),
low = exp(low))
svg(glue("figures/Fig2/fig2_range.svg"),
width = 3, height = 2.8)
ggplot(aes(x = ran, y = mean), data = mig_efftab) +
geom_errorbar(aes(ymin=low, ymax=up, color = factor(ran)), width=.1,
position=position_dodge(.9), data = mig_efftab) +
geom_point(aes(x = ran, y = mean, col = ran), data = mig_efftab, size = 2) +
scale_color_manual(values = c("mig" = "#E69F00", "bree" = "#F0E442")) +
theme_bw() +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.line = element_line(colour = "black", size = 0.35),
panel.border = element_blank(),
panel.background = element_blank(),
axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.y = element_text(angle=90, hjust=0.5, size = 12, colour = "black"),
axis.text.x = element_text(size = 12, colour = "black"),
legend.position = "none",
axis.ticks.length = unit(0.3, "cm"),
axis.ticks = element_line(colour = "black", size = 0.35),
rect = element_rect(fill = "transparent")) +
scale_y_continuous(trans='log10', limits = c(3.7, 4.6),
breaks = log(c(40,50,60,70,80,90)), labels = c(40,50,60,70,80,90)) +
scale_x_discrete(labels = c("Breeding\nrange","Migratory\nrange"))
# Model 2 - Green-up speed varying according to latitude  --------------------------------------------------------
cellnumbs2 <- cellnumbs %>%
as_tibble() %>%
mutate(cell2 = as.factor(cell2))
colnames(cellnumbs2) <- c("cell2", "cell")
finalG <- left_join(finalG, cellnumbs2)
cells2 <- cells[,1:2]
colnames(cells2) <- c("cell", "cell_lat2")
cells2 <- cells2 %>%
mutate(cell = as.factor(cell))
finalG <- left_join(finalG, cells2[,1:2])
mod_lat_guspe <-
mgcv::gam(data = finalG,
log(vGrMag) ~
s(cell_lat2, bs = "tp") +
s(cell, bs = "re") +
s(year, bs = "re")
)
summary(mod_lat_guspe)
plot_smooth(mod_lat_guspe, view = "cell_lat2",
rug = F, transform = "exp", log = "y",
rm.ranef = T,
#add = T,
col = "#009E73",
#ylab = "Green-up speed (km/day, log-scale)",
ylab = "Speed (km/day, log-scale)",
xlab = "Latitude (degrees)",
lwd = 2,
ylim = c(15,305),
xlim = c(30,48),
xaxt='n')
# define a custom axis
axis(side = 1, at = c(30, 35, 40, 45, 50))
#svg(glue("figures/Fig3/fig3_bird.svg"),
#   width = 4, height = 3)
plot_smooth(mod_gu, view = "cell_lat2",
transform = "exp", log = "y",
rug = F, rm.ranef = TRUE,
col = "#CC79A7",
ylab = "Bird migratory speed (km/day, log-scale)",
xlab = "Latitude (degrees)",
lwd = 2,
add = T,
xlim = c(30,48),
xaxt='n')
legend(42.5, 295, legend=c("Green-up", "Bird"),
col=c("#009E73", "#CC79A7"), lty = 1, cex=0.6, lwd = 1.5)
# Model 3 - Anomaly on lag varying according to z-scores --------------------------------------------------------
final_lag1 <- final2 %>%
dplyr::select(species,
year,
cell, cell_lat2, cell_lng,
sps_cell,
ea_lat, ea_lat_ano, ea_lat_yr, #ea_lat_yr_ano,
arr_GAM_mean,
vArrMag, AnomVArr,
gr_mn, AnomDGr,
vGrMag, AnomVGr,
lag, AnomLag, breed_cell) %>%
filter(!is.na(arr_GAM_mean))%>%
filter(!is.na(ea_lat)) %>%
filter(breed_cell == T) %>%
mutate(cell = as.numeric(cell))
spslist <- sort(unique(final_lag1$species))
final_lag5 <- as.data.frame(matrix(NA, ncol = 4, nrow = 0))
## get species past speed
for(s in 1:length(spslist)){
final_lag2 <- final_lag1 %>% filter(species == spslist[s])
years <- final_lag2 %>% dplyr::select(year) %>% arrange() %>% distinct() %>% pull
for(y in 1:length(years)){
final_lag3 <- final_lag2 %>% filter(year == years[y])
cellsLoop <- final_lag3 %>% dplyr::select(cell) %>% arrange() %>% distinct() %>% pull
# get minimum cell and date for that year
date <- final_lag3 %>% dplyr::select(ea_lat) %>% pull() %>% first()
place <- final_lag3 %>% dplyr::select(cell_lat2, cell_lng) %>% arrange(cell_lat2) %>% filter(row_number()==1)
for(d in 1:length(cellsLoop)){
final_lag4 <- final_lag3 %>% filter(cell == cellsLoop[d])
date2 <- final_lag4 %>% dplyr::select(arr_GAM_mean) %>% pull()
place2 <- final_lag4 %>% dplyr::select(cell_lat2, cell_lng) %>% filter(row_number()==1)
spe_bef <- (geodist::geodist(c(place2[1,2], place2[1,1]), c(place[1,2], place[1,1]), measure = 'geodesic' )/1000)/
(date2 - date)
if(spe_bef > 0) {final_lag5 <- rbind(final_lag5,
cbind(as.data.frame(spslist[s]), years[y], cellsLoop[d], spe_bef))} else {print("upa")}
}
}
}
colnames(final_lag5) <- c("species", "year", "cell", "past_spe")
final_lag5$year <- as.numeric(final_lag5$year)
final_lag5$cell <- as.numeric(final_lag5$cell)
final_lag5$past_spe <- as.numeric(final_lag5$past_spe)
final_lag <- left_join(final_lag1, final_lag5, by = c("species", "year", "cell"))
cellspec <- unique(final_lag[ ,c("cell","species")])
final3 <- matrix(NA, 0, (ncol(final_lag) + 3))
## scale past speed, green-up day and sps arrival date
for (a in 1:nrow(cellspec)){  # loop in a cell and species
dat.temp <- subset(final_lag, cellspec[a,1] == cell & cellspec[a,2] == species)
if (nrow(dat.temp) >= 8){  # at least 8 years of data
Anom <- apply(dat.temp[,c("past_spe","ea_lat_yr","gr_mn")], 2,
function(x) scale(x, scale = T))
colnames(Anom) <- c("past_spe_z","ea_lat_yr_z","gr_mn_z")
dat.temp <- cbind(dat.temp, Anom)
final3 <- rbind(final3, dat.temp)
}
}
cor(final3$past_spe_z, final3$ea_lat_yr_z, use = "na.or.complete")
cor(final3$past_spe_z, final3$gr_mn_z, use = "na.or.complete")
cor(final3$gr_mn_z, final3$ea_lat_yr_z, use = "na.or.complete")
mod_lag <-
mgcv::gam(data = final3,
AnomLag ~ past_spe_z + ea_lat_yr_z + gr_mn_z +
s(cell, bs = "re") +
s(sps_cell, bs = "re")
)
summary(mod_lag)
hwicol <- read_csv("data/birds_HWI.csv") %>%
dplyr::select(species, `HWI`)  ## used the IUCN names
final4 <- left_join(final2, hwicol, by="species")
mod_tra <-
mgcv::gam(data = final4,
log(vArrMag) ~ xi_mean + ea_lat + Diet + Body_mass_g + winlat + Time + HWI +
s(cell_lat, bs = "tp") +
s(sps_cell, bs = "re") +
s(year, bs = "re") +
s(cell, bs = "re")
)
# mod_tra <-
#   mgcv::gam(data = final4,
#             log(vArrMag) ~ xi_mean + ea_lat_s + Diet + Body_mass_g_s + winlat_s + Time +
#               HWI_s +
#               s(cell_lat2, bs = "tp") +
#               s(species, bs = "re") +
#               s(sps_cell, bs = "re") +
#               s(year, bs = "re")
#   )
# saveRDS(mod_tra, file = "data/res/mod_tra.rds")
# mod_tra <- readRDS(file = "data/res/mod_tra.rds")
summary(mod_tra)
## Figure 4 - smooth for traits effects ------------------------------------------------------------------------
# Model 1 - bird speed varying with green-up --------------------------------------------------------
mod_gu2 <-
mgcv::gam(data = final2,
log(vArrMag) ~ (AnomDGr + AnomVGr) * mig_cell +
s(cell_lat2, bs = "tp") * mig_cell +
s(year, bs = "re") +
s(cell_lat2, bs = "tp") +
s(sps_cell, bs = "re") +
s(cell, bs = "re")
)
# Model 1 - bird speed varying with green-up --------------------------------------------------------
mod_gu2 <-
mgcv::gam(data = final2,
log(vArrMag) ~ (AnomDGr + AnomVGr) * mig_cell +
s(year, bs = "re") +
s(cell_lat2, bs = "tp", by = mig_cell) +
s(sps_cell, bs = "re") +
s(cell, bs = "re")
)
summary(mod_gu2)
plot_smooth(mod_gu, view = "AnomDGr", cond=list(mig_cell=F),
ylim = exp(c(3.7,4.6)),
rug = F, transform = "exp", log = "y",
ylab = "Bird speed (km/day, log scale)", xlab = "Anomaly on green-up date (days)",
col = "#F0E442", lwd = 3)
plot_smooth(mod_gu, view = "AnomDGr", cond=list(mig_cell=T), add = T,
rug = F,lty = "dashed", transform = "exp", log = "y",
col = "#E69F00", lwd = 3)
plot_smooth(mod_gu2, view = "AnomDGr", cond=list(mig_cell=F),
ylim = exp(c(3.7,4.6)),
rug = F, transform = "exp", log = "y",
ylab = "Bird speed (km/day, log scale)", xlab = "Anomaly on green-up date (days)",
col = "#F0E442", lwd = 3)
plot_smooth(mod_gu2, view = "AnomDGr", cond=list(mig_cell=T), add = T,
rug = F,lty = "dashed", transform = "exp", log = "y",
col = "#E69F00", lwd = 3)
summary(mod_gu2)
summary(mod_gu)
AIC(mod_gu, mod_gu2)
BIC(mod_gu, mod_gu2)
WAIC(mod_gu, mod_gu2)
wAIC(mod_gu, mod_gu2)
waic(mod_gu, mod_gu2)
save.image("~/Documents/GitHub/BirdMigrationSpeed/data/crazy_hugedec26.RData")
load("~/Documents/GitHub/BirdMigrationSpeed/data/crazy_hugedec26.RData")
load("~/Documents/GitHub/BirdMigrationSpeed/data/crazy_hugedec26.RData")
summary(mod_tra)
final3$past_spe_z
final3$past_spe_z %>% mean()
library(tidyverse)
final3$past_spe_z %>% mean()
final3$past_spe_z %>% mean(na.rm = T)
Anom
dat.temp
dat.temp$ea_lat_yr
final_lag$ea_lat_yr
final_lag$ea_lat_yr %>% mean(na.rm = T)
final_lag$ea_lat_yr %>% hist()
summary(mod_lag)
final_lag$past_spe %>% hist()
final_lag$past_spe %>% mean(na.rm = T)
final_lag$past_spe %>% sd(na.rm = T)
pasts < - final_lag$past_spe
pasts <- final_lag$past_spe
pasts[which(pasts < 800),] %>% mean(na.rm = T)
pasts[which(pasts < 800)] %>% mean(na.rm = T)
pasts[which(pasts < 3000)] %>% mean(na.rm = T)
pasts[which(pasts < 3000)] %>% sd(na.rm = T)
pasts[which(pasts < 3000)] %>% hist()
heda(final3)
head(final3)
final_lag$gr_mn %>% sd(na.rm = T)
### Hand-wing index (HWI) ---------------------------------------------------------------------------------------------------------
plot_smooth(mod_tra, view = "HWI", transform = "exp", log = "y",
xlab = "Hand-wing index (HWI)", ylab = "Bird migratory speed (km/day, log-scale)",
col = "#CC79A7", rug = F, lwd = 3)
# 3_ModelPlots.R -------------------------
#
# Code to analyze how bird arrival date speed is affected by green-up, bird traits and latitude,
#    which factors contribute to anomalies in lag, and how green-up varies according to latitude
# models and plotting outputs
#
# Input:  data/final.rds
#         data/cellcoor.rds
#         data/cellnumbs.rds
#
# Output:
#
#
#
# Color-blind friendly colors:
# Green-up: #009E73 (green)
# Bird: #CC79A7 (pink)
# Migratory range: #E69F00 (orange)
# Breeding range: #F0E442 (yellow)
#
# Load packages ----------------------------
library(mgcv)
library(tidyverse)
library(gratia)
library(ggplot2)
library(dplyr)
library(tidymv)
library(itsadug)
library(glue)
library(viridis)
library(scales)
library(here)
library(readr)
library(janitor)
library(ggrepel)
## Figure 1 - maps of migration speed ----------------------------------
# maps are made sourcing script 5_Maps_230125.R
source("code/5_Maps_230125.R")
### Hand-wing index (HWI) ---------------------------------------------------------------------------------------------------------
plot_smooth(mod_tra, view = "HWI", transform = "exp", log = "y",
xlab = "Hand-wing index (HWI)", ylab = "Bird migratory speed (km/day, log-scale)",
col = "#CC79A7", rug = F, lwd = 3)
load("~/Documents/GitHub/BirdMigrationSpeed/data/crazy_hugedec26.RData")
### Hand-wing index (HWI) ---------------------------------------------------------------------------------------------------------
plot_smooth(mod_tra, view = "HWI", transform = "exp", log = "y",
xlab = "Hand-wing index (HWI)", ylab = "Bird migratory speed (km/day, log-scale)",
col = "#CC79A7", rug = F, lwd = 3)
## Figure 5 - individual species speeds ----------------------------------
### species speeds histogram -------------------------
ggplot(data = final %>% filter(species != "Pipilo_erythrophthalmus")) + # no estimates, no neighbors
geom_boxplot(aes(x = reorder(species2,
#xi_mean,
log(vArrMag),
FUN = median, na.rm = TRUE),
y = log(vArrMag)#, fill = ea_lat
),
width=0.5, alpha = 0.7) +
theme_bw() +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.title = element_text(size = 10),
axis.title.x = element_blank(),
#axis.title.y = element_blank(),
#axis.text.y=element_blank(),
legend.title.align = 0.5,
plot.title = element_text(hjust = 0.5, size=10),
axis.text.x = element_text(angle = 90, vjust = 0.5,
hjust=1, face = "italic")) +
#labs(title="Species") +
scale_fill_viridis(name = "Species first \narrival date\n") +
labs(y = "Log(Speed)\n") +
scale_y_continuous(trans='log10', breaks = c(10,100,1000,5000), labels = c(10,100,1000,5000))
cellnumbs <- readRDS(file = "data/cellnumbs.rds")
cells <- readRDS(file = "data/cellcoor.rds")
final2 <- readRDS("~/OneDrive/BirdMigrationSpeed_copy/final.rds") %>%
#"~/Library/CloudStorage/OneDrive-ThePennsylvaniaStateUniversity/BirdMigrationSpeed_copy/data/final.rds") %>%
mutate(species = as.factor(species),
cell = as.factor(cell),
#mig_cell = abs(mig_cell - 1),
mig_cell = as.factor(mig_cell),# %>% as.numeric(),
sps_cell = as.factor(glue("{species}_{cell}"))
)
finalG <- final2 %>%
dplyr::select(cell, year, cell_lat2, vGrMag, gr_mn, mig_cell, breed_cell) %>%
distinct() %>%
mutate(cell = as.factor(cell),
mig_cell = as.factor(mig_cell))
## Figure 5 - individual species speeds ----------------------------------
### species speeds histogram -------------------------
ggplot(data = final2 %>% filter(species != "Pipilo_erythrophthalmus")) + # no estimates, no neighbors
geom_boxplot(aes(x = reorder(species2,
#xi_mean,
log(vArrMag),
FUN = median, na.rm = TRUE),
y = log(vArrMag)#, fill = ea_lat
),
width=0.5, alpha = 0.7) +
theme_bw() +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.title = element_text(size = 10),
axis.title.x = element_blank(),
#axis.title.y = element_blank(),
#axis.text.y=element_blank(),
legend.title.align = 0.5,
plot.title = element_text(hjust = 0.5, size=10),
axis.text.x = element_text(angle = 90, vjust = 0.5,
hjust=1, face = "italic")) +
#labs(title="Species") +
scale_fill_viridis(name = "Species first \narrival date\n") +
labs(y = "Log(Speed)\n") +
scale_y_continuous(trans='log10', breaks = c(10,100,1000,5000), labels = c(10,100,1000,5000))
ggplot(final, aes(x = log(vArrMag))) +
geom_histogram(aes(y = (..count..)/sum(..count..))) +
coord_flip() +
theme_bw() +
scale_x_continuous(trans='log10',
breaks = log(c(10,50,250,1000)),
labels = c(10,50,250,1000)) +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.title.x = element_blank(),
axis.title.y = element_blank())
summary(mod_tra)
summary(mod_tra2)
mod_tra2 <-
mgcv::gam(data = final4,
log(vArrMag) ~ xi_mean + ea_lat + #Diet +
Body_mass_g + winlat + #Time +
HWI +
s(cell_lat, bs = "tp") +
s(sps_cell, bs = "re") +
s(year, bs = "re") +
s(cell, bs = "re")
)
summary(mod_tra2)
hist(final4$Body_mass_g)
scale(final4$Body_mass_g)
hist(final4$HWI)
mod_tra2 <-
mgcv::gam(data = final4,
log(vArrMag) ~ scale(xi_mean) +
scale(ea_lat) + #Diet +
scale(Body_mass_g) +
scale(winlat) + #Time +
scale(HWI) +
s(cell_lat, bs = "tp") +
s(sps_cell, bs = "re") +
s(year, bs = "re") +
s(cell, bs = "re")
)
save.image("~/Documents/GitHub/BirdMigrationSpeed/data/crazy_hugedec27.RData")
